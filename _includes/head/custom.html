<!-- Early theme bootstrap: set theme before first paint to avoid flash -->
<script>
(function() {
  try {
    var saved = localStorage.getItem('theme-mode') || 'auto';
    var actualTheme;
    
    if (saved === 'auto') {
      actualTheme = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    } else {
      actualTheme = saved;
    }
    
    document.documentElement.setAttribute('data-theme', actualTheme);
    // Update theme-color for mobile UI
    var meta = document.querySelector('meta[name="theme-color"]');
    if (!meta) {
      meta = document.createElement('meta');
      meta.setAttribute('name', 'theme-color');
      document.head.appendChild(meta);
    }
    meta.setAttribute('content', actualTheme === 'dark' ? '#0f1419' : '#ffffff');
  } catch(e) {}
})();
</script>

<!-- Custom Dark Mode Toggle CSS -->
<style>
  :root {
    --bg-color: #ffffff;
    --text-color: #333333;
    --header-bg: #ffffff;
    --card-bg: #f8f9fa;
    --border-color: #e9ecef;
    --link-color: #007bff;
    --accent-color: #007bff; /* used for emphasis like the toggle ring */
    --sidebar-bg: #f8f9fa;
    --code-bg: #f8f9fa;
    --theme-transition-duration: 320ms;
  }

  /* Inform the UA about intended color scheme for built-in UI */
  html[data-theme="dark"] { color-scheme: dark; }
  html[data-theme="light"] { color-scheme: light; }

  [data-theme="dark"] {
    /* Refined dark palette (neutral blue-gray) */
    --bg-color: #0f1419;           /* page background */
    --header-bg: #0b1117;          /* masthead/footer */
    --card-bg: #11161c;            /* cards, list items */
    --sidebar-bg: var(--bg-color); /* sidebars/nav blocks match page bg */
    --border-color: #243041;       /* separators and borders */

    --text-color: #e6e8eb;         /* primary text */
    --text-muted: #a0a6ad;         /* secondary text */

    --link-color: #7bc4ff;         /* links */
    --link-hover-color: #a8dbff;   /* link hover */
    --accent-color: #3da9fc;       /* active accents */

    --nav-hover-bg: #182231;       /* nav hover background */
    --nav-active-bg: #1d2a3a;      /* nav active background */
    --code-bg: #0e151b;            /* code blocks */
  }

  /* Apply theme variables - Light mode (default) keeps original colors */
  body {
    transition: background-color var(--theme-transition-duration) ease,
                color var(--theme-transition-duration) ease;
  }

  /* Only apply dark theme overrides when dark mode is active */
  [data-theme="dark"] body {
    background-color: var(--bg-color) !important;
    color: var(--text-color) !important;
  }

  [data-theme="dark"] .masthead, 
  [data-theme="dark"] .page__footer {
    background-color: var(--header-bg) !important;
    border-bottom: 1px solid var(--border-color) !important;
  }

  /* Top navigation (greedy-nav) */
  [data-theme="dark"] .greedy-nav {
    background-color: var(--header-bg) !important;
    border-bottom: 1px solid var(--border-color) !important;
  }
  [data-theme="dark"] .greedy-nav .visible-links a,
  [data-theme="dark"] .masthead__menu-item a,
  [data-theme="dark"] .site-title a {
    color: var(--text-color) !important;
  }
  [data-theme="dark"] .greedy-nav .visible-links a:hover,
  [data-theme="dark"] .masthead__menu-item a:hover {
    background-color: var(--nav-hover-bg) !important;
    color: var(--text-color) !important;
  }
  [data-theme="dark"] .greedy-nav .visible-links a[aria-current="page"],
  [data-theme="dark"] .masthead__menu-item a[aria-current="page"] {
    box-shadow: inset 0 -2px 0 0 var(--accent-color);
    background-color: var(--nav-active-bg);
  }

  /* Mobile hamburger menu (hidden-links) */
  [data-theme="dark"] .greedy-nav .hidden-links {
    background-color: var(--header-bg) !important;
    border: 1px solid var(--border-color) !important;
    box-shadow: 0 8px 24px rgba(0,0,0,0.35);
  }
  [data-theme="dark"] .greedy-nav .hidden-links a {
    color: var(--text-color) !important;
  }
  [data-theme="dark"] .greedy-nav .hidden-links a:hover {
    background-color: var(--nav-hover-bg) !important;
    color: var(--text-color) !important;
  }
  /* Hidden-links caret colors in dark mode */
  [data-theme="dark"] .greedy-nav .hidden-links::before {
    border-color: var(--border-color) transparent !important;
  }
  [data-theme="dark"] .greedy-nav .hidden-links::after {
    border-color: var(--header-bg) transparent !important;
  }
  /* Hamburger icon lines */
  [data-theme="dark"] .greedy-nav__toggle,
  [data-theme="dark"] .greedy-nav__toggle:hover,
  [data-theme="dark"] .greedy-nav__toggle:focus {
    color: var(--text-color) !important;
  }
  [data-theme="dark"] .greedy-nav .navicon,
  [data-theme="dark"] .greedy-nav .navicon::before,
  [data-theme="dark"] .greedy-nav .navicon::after {
    background-color: var(--text-color) !important;
  }

  /* Fix white overlay from theme's hamburger toggle (::before) in dark mode */
  [data-theme="dark"] .greedy-nav__toggle::before {
    background-color: var(--header-bg) !important; /* was $background-color (light) */
  }
  [data-theme="dark"] .greedy-nav__toggle.close::before {
    opacity: 0.9 !important; /* keep same intensity but with dark color */
  }
  /* Ensure hover doesn't re-tint icon lines to a lighter mix */
  [data-theme="dark"] .greedy-nav__toggle:hover .navicon,
  [data-theme="dark"] .greedy-nav__toggle:hover .navicon::before,
  [data-theme="dark"] .greedy-nav__toggle:hover .navicon::after {
    background-color: var(--text-color) !important;
  }

  /* Dim page behind the mobile menu using a non-interactive viewport overlay */
  /* Robust overlay using a class (no :has dependency) */
  html.nav-dim::after {
    content: "";
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.45);
    pointer-events: none;
    z-index: 9500;
  }
  [data-theme="dark"] html.nav-dim::after {
    background: rgba(8, 12, 17, 0.66);
    backdrop-filter: saturate(90%) blur(1px);
  }
  /* Ensure the dropdown sits above overlay */
  .greedy-nav .hidden-links { z-index: 10001 !important; }

  [data-theme="dark"] .sidebar,
  [data-theme="dark"] .sidebar__right,
  [data-theme="dark"] .page__sidebar {
    background-color: var(--sidebar-bg) !important;
  }

  [data-theme="dark"] .archive__item, 
  [data-theme="dark"] .list__item {
    background-color: var(--card-bg) !important;
    border: 1px solid var(--border-color) !important;
  }

  [data-theme="dark"] .page__content {
    background-color: var(--bg-color) !important;
  }

  [data-theme="dark"] .page__title, 
  [data-theme="dark"] .archive__item-title, 
  [data-theme="dark"] h1, 
  [data-theme="dark"] h2, 
  [data-theme="dark"] h3, 
  [data-theme="dark"] h4, 
  [data-theme="dark"] h5, 
  [data-theme="dark"] h6 {
    color: var(--text-color) !important;
  }

  [data-theme="dark"] a {
    color: var(--link-color) !important;
  }

  [data-theme="dark"] code, 
  [data-theme="dark"] pre {
    background-color: var(--code-bg) !important;
    color: var(--text-color) !important;
  }

  [data-theme="dark"] .nav__list .nav__items {
    background-color: var(--sidebar-bg) !important;
  }
  [data-theme="dark"] .nav__list .nav__items a {
    color: var(--text-color) !important;
  }
  [data-theme="dark"] .nav__list .nav__items a:hover {
    background-color: var(--nav-hover-bg) !important;
  }

  [data-theme="dark"] .nav__title {
    background-color: var(--card-bg) !important;
    color: var(--text-color) !important;
  }

  [data-theme="dark"] .site-title a,
  [data-theme="dark"] .masthead__menu-item a {
    color: var(--text-color) !important;
  }

  /* Muted text utility in dark mode */
  [data-theme="dark"] .page__meta,
  [data-theme="dark"] .page__lead,
  [data-theme="dark"] .author__bio,
  [data-theme="dark"] .archive__item-excerpt {
    color: var(--text-muted) !important;
  }

  /* Link hover color refinement */
  [data-theme="dark"] a:hover {
    color: var(--link-hover-color) !important;
  }

  /* During swap, suppress per-element transitions to avoid stagger; overlay handles visual */
  .theme-suppress body,
  .theme-suppress .masthead,
  .theme-suppress .page__footer,
  .theme-suppress .sidebar,
  .theme-suppress .sidebar__right,
  .theme-suppress .page__sidebar,
  .theme-suppress .page__content,
  .theme-suppress .archive__item,
  .theme-suppress .list__item,
  .theme-suppress .nav__list .nav__items,
  .theme-suppress .nav__title,
  .theme-suppress .page__title,
  .theme-suppress .archive__item-title,
  .theme-suppress h1,
  .theme-suppress h2,
  .theme-suppress h3,
  .theme-suppress h4,
  .theme-suppress h5,
  .theme-suppress h6,
  .theme-suppress a,
  .theme-suppress code,
  .theme-suppress pre {
    transition: none !important;
  }

  /* Toggle pulse animation on click */
  .theme-toggle.pulse {
    animation: pulse-glow 400ms ease;
  }
  @keyframes pulse-glow {
    0%   { box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.35), 0 2px 8px rgba(0,0,0,0.1); }
    60%  { box-shadow: 0 0 0 10px rgba(0, 123, 255, 0.0), 0 4px 14px rgba(0,0,0,0.2); }
    100% { box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.0), 0 2px 8px rgba(0,0,0,0.1); }
  }

  /* Respect reduced-motion preferences */
  @media (prefers-reduced-motion: reduce) {
    :root { --theme-transition-duration: 0ms; }
    .theme-toggle { transition: none !important; }
    .theme-toggle.pulse { animation: none !important; }
  }

  /* Full-screen overlay to mask theme transitions */
  .theme-fade-overlay {
    position: fixed;
    inset: 0;
    background: var(--bg-color);
    opacity: 0;
    transition: opacity var(--theme-transition-duration) ease;
    pointer-events: none;
    z-index: 9999;
    will-change: opacity;
  }
  .theme-fade-overlay.show { opacity: 1; }
  @media (prefers-reduced-motion: reduce) {
    .theme-fade-overlay { transition: none; }
  }

  /* Theme toggle positioned at bottom-right */
  html body .theme-toggle.theme-toggle.theme-toggle {
    position: fixed !important;
    bottom: 20px !important;
    right: 20px !important;
    background: transparent !important;
    border: none !important;
    border-radius: 0 !important;
    width: 120px !important;
    height: 50px !important;
    padding: 0 !important;
    display: block !important;
    cursor: pointer !important;
    transition: all 0.2s ease !important;
    appearance: none !important;
    -webkit-appearance: none !important;
    overflow: visible !important;
    z-index: 1000 !important;
  }

  /* Toggle track area - horizontal with rounded corners */
  .theme-toggle::after {
    content: "" !important;
    position: absolute !important;
    top: 15px !important;
    left: 25px !important;
    width: 70px !important;
    height: 18px !important;
    background: var(--card-bg) !important;
    border: 1px solid var(--border-color) !important;
    border-radius: 12px !important;
    z-index: 0 !important;
  }

  /* Position theme toggle in navigation */
  .greedy-nav {
    position: relative !important;
  }

  .greedy-nav::after {
    content: '' !important;
    position: absolute !important;
    right: 0 !important;
    top: 50% !important;
    transform: translateY(-50%) !important;
    pointer-events: none !important;
  }

  /* Circular sliding indicator - moves horizontally within track */
  .theme-toggle::before {
    content: "" !important;
    position: absolute !important;
    width: 12px !important;
    height: 12px !important;
    background: var(--accent-color) !important;
    border-radius: 50% !important;
    transition: all 0.2s ease !important;
    z-index: 1 !important;
    top: 18px !important;
  }

  /* Position circular indicator based on selected mode */
  .theme-toggle[data-mode="light"]::before {
    left: 28px !important;
  }
  .theme-toggle[data-mode="auto"]::before {
    left: 54px !important;
  }
  .theme-toggle[data-mode="dark"]::before {
    left: 80px !important;
  }

  /* Labels positioned around the toggle track */
  .theme-option {
    position: absolute !important;
    font-size: 10px !important;
    line-height: 1 !important;
    z-index: 2 !important;
    transition: opacity 0.2s ease !important;
    color: var(--text-color) !important;
    font-weight: 500 !important;
    font-family: system-ui, -apple-system, sans-serif !important;
    text-transform: uppercase !important;
    letter-spacing: 0.5px !important;
    pointer-events: none !important;
  }

  /* Position labels - Light and Dark above, Auto below center */
  .theme-option[data-theme-mode="light"] {
    top: 2px !important;
    left: 22px !important;
  }
  .theme-option[data-theme-mode="auto"] {
    bottom: 4px !important;
    left: 50% !important;
    transform: translateX(-50%) !important;
  }
  .theme-option[data-theme-mode="dark"] {
    top: 2px !important;
    right: 22px !important;
  }

  /* Hide toggle on mobile - high specificity */
  @media (max-width: 600px) {
    html body .theme-toggle.theme-toggle.theme-toggle {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
    }
  }


  .theme-toggle:hover {
    border-color: var(--accent-color) !important;
    background: rgba(var(--accent-color), 0.05) !important;
  }

  /* Remove focus outline */
  .theme-toggle:focus {
    outline: none !important;
    box-shadow: none !important;
  }

  /* Dark mode styling for toggle bar */
  [data-theme="dark"] .theme-toggle {
    background: transparent !important;
    border-color: var(--border-color) !important;
  }

  /* Selected option styling */
  .theme-toggle[data-mode="light"] .theme-option[data-theme-mode="light"],
  .theme-toggle[data-mode="auto"] .theme-option[data-theme-mode="auto"],
  .theme-toggle[data-mode="dark"] .theme-option[data-theme-mode="dark"] {
    color: var(--accent-color) !important;
    font-weight: 600 !important;
  }

  /* Unselected options are more subtle */
  .theme-option {
    opacity: 0.5 !important;
  }
  .theme-toggle[data-mode="light"] .theme-option[data-theme-mode="light"],
  .theme-toggle[data-mode="auto"] .theme-option[data-theme-mode="auto"],
  .theme-toggle[data-mode="dark"] .theme-option[data-theme-mode="dark"] {
    opacity: 1 !important;
  }



  /* Dark mode author profile adjustments */
  [data-theme="dark"] .author__avatar img {
    border: 3px solid var(--border-color) !important;
  }

  [data-theme="dark"] .author__content {
    color: var(--text-color) !important;
  }

  [data-theme="dark"] .author__bio {
    color: var(--text-color) !important;
  }

  /* Responsive navigation buttons */
  .greedy-nav .visible-links {
    display: flex !important;
    flex: 1 !important;
  }

  /* Adjust the overall nav layout */
  .greedy-nav {
    display: flex !important;
    align-items: center !important;
  }

  /* Make sure the site title stays in place */
  .site-title {
    margin-right: auto !important;
  }

  /* Dynamic right-align navigation with responsive margins */
  @media (min-width: 1024px) {
    .greedy-nav .visible-links {
      justify-content: flex-end !important;
      margin-right: 3rem !important;
    }
  }

  /* Right-align navigation on medium screens */
  @media (max-width: 1023px) and (min-width: 768px) {
    .greedy-nav .visible-links {
      justify-content: flex-end !important;
      margin-right: 2rem !important;
    }
  }

  /* Right-align navigation on small screens */
  @media (max-width: 767px) {
    .greedy-nav .visible-links {
      justify-content: flex-end !important;
      margin-right: 1rem !important;
    }
  }

  /* Fix GitHub icon visibility in dark mode */
  [data-theme="dark"] .fa-github,
  [data-theme="dark"] .fa-github-alt,
  [data-theme="dark"] .fa-github-square,
  [data-theme="dark"] .fab.fa-github,
  [data-theme="dark"] .fab.fa-fw.fa-github {
    color: var(--text-color) !important;
    filter: none !important;
  }

  /* Also handle any other dark social icons that might be hard to see */
  [data-theme="dark"] .fa-twitter,
  [data-theme="dark"] .fab.fa-twitter,
  [data-theme="dark"] .fab.fa-fw.fa-twitter {
    color: #1da1f2 !important; /* Twitter blue - more visible than black */
  }
</style>

<!-- Dark Mode Toggle Script -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Create toggle button container
  const toggleButton = document.createElement('button');
  toggleButton.className = 'theme-toggle';
  toggleButton.setAttribute('aria-label', 'Theme selector');
  toggleButton.setAttribute('title', 'Click to cycle theme modes');
  
  // Create the three theme options
  const lightOption = document.createElement('div');
  lightOption.className = 'theme-option';
  lightOption.innerHTML = 'Light';
  lightOption.setAttribute('data-theme-mode', 'light');
  
  const autoOption = document.createElement('div');
  autoOption.className = 'theme-option';
  autoOption.innerHTML = 'Auto';
  autoOption.setAttribute('data-theme-mode', 'auto');
  
  const darkOption = document.createElement('div');
  darkOption.className = 'theme-option';
  darkOption.innerHTML = 'Dark';
  darkOption.setAttribute('data-theme-mode', 'dark');
  
  // Add options to toggle button
  toggleButton.appendChild(lightOption);
  toggleButton.appendChild(autoOption);
  toggleButton.appendChild(darkOption);
  
  // Add button to body - completely separate from navigation
  document.body.appendChild(toggleButton);

  // No nav overlap: keep toggle in bottom-right; no dynamic top calculations needed
  
  // Check for saved theme mode or default to auto
  const savedMode = localStorage.getItem('theme-mode') || 'auto';
  const currentTheme = getCurrentTheme(savedMode);
  document.documentElement.setAttribute('data-theme', currentTheme);
  
  // Force initial theme update after button is added to DOM
  setTimeout(() => {
    updateToggleButton(savedMode, currentTheme);
  }, 10);
  
  // Auto mode: listen for system preference changes
  if (window.matchMedia) {
    const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
    mediaQuery.addListener(() => {
      const currentMode = localStorage.getItem('theme-mode') || 'auto';
      if (currentMode === 'auto') {
        const newTheme = getCurrentTheme('auto');
        document.documentElement.setAttribute('data-theme', newTheme);
        updateToggleButton(currentMode, newTheme);
        
        // Update theme-color meta
        const meta = document.querySelector('meta[name="theme-color"]');
        if (meta) meta.setAttribute('content', newTheme === 'dark' ? '#0f1419' : '#ffffff');
      }
    });
  }
  
  // Helper function to determine actual theme from mode
  function getCurrentTheme(mode) {
    if (mode === 'auto') {
      return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    }
    return mode;
  }

  // Debug function - open browser console and type: testAutoMode(15) to test 3PM
  window.testAutoMode = function(testHour) {
    const savedDate = Date;
    Date = function() {
      const d = new savedDate();
      d.getHours = () => testHour;
      return d;
    };
    Date.prototype = savedDate.prototype;
    
    const newTheme = getCurrentTheme('auto');
    console.log(`Testing hour ${testHour}: theme should be ${newTheme}`);
    
    if (localStorage.getItem('theme-mode') === 'auto') {
      document.documentElement.setAttribute('data-theme', newTheme);
      updateToggleButton('auto', newTheme);
    }
    
    // Restore original Date
    setTimeout(() => { Date = savedDate; }, 100);
  };
  
  // Create overlay element once
  const overlay = document.createElement('div');
  overlay.className = 'theme-fade-overlay';
  document.body.appendChild(overlay);

  // Cycle through theme modes on button click with overlay mask + pulse
  toggleButton.addEventListener('click', function() {
    const currentMode = localStorage.getItem('theme-mode') || 'auto';
    const currentTheme = document.documentElement.getAttribute('data-theme');
    
    // Cycle: light → auto → dark → light
    let newMode;
    if (currentMode === 'light') {
      newMode = 'auto';
    } else if (currentMode === 'auto') {
      newMode = 'dark';
    } else {
      newMode = 'light';
    }
    
    const newTheme = getCurrentTheme(newMode);

    // Prevent staggered transitions while overlay is up
    document.documentElement.classList.add('theme-suppress');
    toggleButton.classList.add('pulse');

    // Lock overlay color to current theme so it covers consistently during fade
    const currentIsDark = currentTheme === 'dark';
    overlay.style.backgroundColor = currentIsDark ? '#0f1419' : '#ffffff';
    // Show overlay immediately at full opacity
    overlay.classList.add('show');

    // After overlay is visible, switch theme and then fade out
    setTimeout(() => {
      // Update theme-color meta to target theme early
      const themeColor = newTheme === 'dark' ? '#0f1419' : '#ffffff';
      const meta = document.querySelector('meta[name="theme-color"]');
      if (meta) meta.setAttribute('content', themeColor);

      document.documentElement.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme-mode', newMode);
      updateToggleButton(newMode, newTheme);

      // Allow a tick for repaint, then fade overlay out
      setTimeout(() => {
        overlay.classList.remove('show');
        document.documentElement.classList.remove('theme-suppress');
        toggleButton.classList.remove('pulse');
      }, 20);
    }, 60);
  });
  
  function updateToggleButton(mode, actualTheme) {
    // Set button data attribute for CSS styling
    toggleButton.setAttribute('data-mode', mode);
    
    // Update labels based on current mode
    let label, title;
    if (mode === 'light') {
      label = 'Light mode active';
      title = 'Light mode (click to switch to auto)';
    } else if (mode === 'auto') {
      label = 'Auto mode active';
      title = `Auto mode (system: ${actualTheme}) - Follows your device's appearance setting`;
    } else {
      label = 'Dark mode active';
      title = 'Dark mode (click to switch to light)';
    }
    
    toggleButton.setAttribute('aria-label', label);
    toggleButton.setAttribute('title', title);
  }
});
</script>